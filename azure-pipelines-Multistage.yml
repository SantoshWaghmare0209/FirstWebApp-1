# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none

variables:
  ConnectedServiceName: 'bba9cf9c-0553-4678-bf21-c65e7839ec1d'
  WebAppKind: 'webApp'
  WebAppName: 'demowebapp001'
  #solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  solution: '**\*.sln'

stages:
- stage: Build
  displayName: "Build Stage"
  jobs: 
  - job: BuildJob
    pool:
      vmImage: 'windows-latest' 
    displayName: "Build and Publish Artifacts"
    steps:
    - script: echo "Building the application..."
      displayName: "Build"
    - task: NuGetToolInstaller@0
      displayName: 'Use NuGet 4.4.1'
      inputs:
            versionSpec: 4.4.1
    - task: NuGetCommand@2
      displayName: 'NuGet restore'
      inputs:
        restoreSolution: '$(Parameters.solution)'

    - task: VSBuild@1
      displayName: 'Build solution'
      inputs:
        solution: '$(Parameters.solution)'
        msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactstagingdirectory)\\"'
        platform: '$(BuildPlatform)'
        configuration: '$(BuildConfiguration)'

    - task: VSTest@2
      displayName: 'Test Assemblies'
      inputs:
        testAssemblyVer2: |
        # **\$(BuildConfiguration)\*test*.dll
        # !**\obj\**
        # platform: '$(BuildPlatform)'
        # configuration: '$(BuildConfiguration)'

    - task: PublishSymbols@2
      displayName: 'Publish symbols path'
      inputs:
        SearchPattern: '**\bin\**\*.pdb'
        PublishSymbols: false
      continueOnError: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact'
      inputs:
        PathtoPublish: '$(build.artifactstagingdirectory)'
        ArtifactName: '$(Parameters.ArtifactName)'
      condition: succeededOrFailed()

- stage: "Deploytoappfirst"
  dependsOn: Build
  jobs:
      - deployment: DeployWebAppOnAzureAppService
        displayName: 'Deploy Web App to Azure AppService'
        environment: 'DeploytoAppOne'
        strategy:
          runOnce:
            deploy:
              steps:
              - task: DownloadBuildArtifacts@1
                inputs:
                  buildType: 'specific'
                  project: '8757f6d8-0ada-4daa-9ef5-b9750be607d4'
                  pipeline: '17'
                  buildVersionToDownload: 'latest'
                  downloadType: 'single'
                  artifactName: 'drop'
                  downloadPath: '$(System.ArtifactsDirectory)'
              - task: AzureWebApp@1
                inputs:
                  azureSubscription: 'appservicedep-serviceconnection'
                  appType: 'webApp'
                  appName: 'WebApp2'
                  package: '$(System.DefaultWorkingDirectory)'
                  deploymentMethod: 'zipDeploy'
              
- stage: "DeploytoApptwo"  
  dependsOn: Deploytoappfirst
  jobs:
      - deployment: DeployWebAppOnAzureAppServicetwo
        displayName: 'Deploy Web App to Azure AppService two'
        environment: "DeploytoApptwo"
        strategy:
          runOnce:
            deploy:
              steps:
              - task: DownloadBuildArtifacts@1
                inputs:
                  buildType: 'specific'
                  project: '8757f6d8-0ada-4daa-9ef5-b9750be607d4'
                  pipeline: '17'
                  buildVersionToDownload: 'latest'
                  downloadType: 'single'
                  artifactName: 'drop'
                  downloadPath: '$(System.ArtifactsDirectory)'
              - task: AzureWebApp@1
                inputs:
                  azureSubscription: 'appservicedep-serviceconnection'
                  appType: 'webApp'
                  appName: 'demowebapp001'
                  package: '$(System.DefaultWorkingDirectory)'
                  deploymentMethod: 'zipDeploy'         
